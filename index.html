<!DOCTYPE html>
<html>
<head>
    <title>Titan Tracker v40.6 - Modernized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json,{'name':'Titan Tracker','short_name':'Tracker','display':'standalone','start_url':'.','background_color':'#0b0c0d','theme_color':'#0b0c0d'}">
    <style>
        :root {
            --bg: #0b0c0d;
            --card: #1a1c20;
            --accent: #00e676; 
            --text: #ffffff;
            --field-bg: #25282e;
            --field-border: #444;
            --water: #0dcaf0;
        }

        * { box-sizing: border-box; }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100dvh; 
            overflow: hidden; 
        }

        /* Modernized Header */
        #ui-top { 
            background: var(--card); 
            border-bottom: 1px solid #333; 
            padding: 12px; 
            display: grid; 
            grid-template-columns: 1fr 1fr 2.5fr; 
            gap: 10px; 
            align-items: center; 
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .stat-box { 
            background: var(--field-bg); 
            border-radius: 6px;
            padding: 6px; 
            text-align: center; 
            font-weight: 800; 
            font-size: 10px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #calendar-container { 
            border-radius: 6px;
            height: 24px; 
            position: relative; 
            background: #111; 
            overflow: hidden; 
            border: 1px solid var(--field-border);
        }
        #awake-progress { height: 100%; width: 0%; background: var(--accent); opacity: 0.8; }
        #calendar-text { position: absolute; width: 100%; text-align: center; top: 4px; font-size: 10px; color: #fff; z-index: 2; font-weight: bold; text-transform: uppercase; }

        #viewport-container { position: relative; flex-grow: 1; background: #000; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Modernized Control Card */
        .controls { 
            padding: 20px; 
            background: var(--card); 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 12px; 
            border-top: 1px solid #333; 
            padding-bottom: calc(25px + env(safe-area-inset-bottom)); 
            z-index: 20; 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }

        label { font-size: 0.65rem; color: #888; text-transform: uppercase; margin-bottom: 4px; display: block; }

        select, input { 
            width: 100%;
            background: var(--field-bg); 
            border: 1px solid var(--field-border); 
            color: #fff; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 0.9rem; 
            outline: none;
            font-family: inherit;
        }

        button { 
            padding: 12px; 
            background: var(--field-bg); 
            color: var(--text); 
            border: 1px solid var(--field-border); 
            border-radius: 8px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            font-size: 0.75rem;
            transition: 0.2s; 
        }

        button:active { transform: scale(0.95); }

        .btn-exec { 
            grid-column: span 2; 
            background: var(--accent); 
            color: #000; 
            border: none;
        }
        .btn-exec:active { background: #00c866; }

        .btn-reset { color: #ff5555; border-color: #522; font-size: 0.6rem; }
        
        .control-group { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div id="ui-top">
        <div class="stat-box" id="activeSeason" style="color: var(--accent);">GENESIS</div>
        <div class="stat-box" style="color: var(--water);">W-ZONE: X>3</div>
        <div id="calendar-container">
            <div id="calendar-text"><span id="calDate">1 First Genesis</span> (Day <span id="currentDay">1</span>)</div>
            <div id="awake-progress"></div>
        </div>
    </div>

    <div id="viewport-container"><canvas id="mainCanvas"></canvas></div>

    <div class="controls">
        <div class="control-group"><label>History</label><button onclick="undo()">UNDO</button></div>
        <div class="control-group"><label>Camera</label><button onclick="centerMap()">CENTER</button></div>
        <div class="control-group"><label>Shift</label>
            <select id="mShift"><option value="0">H (0°)</option><option value="22.5">T (+22.5°)</option></select>
        </div>
        <div class="control-group"><label>Titan</label>
            <select id="tName"></select>
        </div>
        
        <div class="control-group" style="grid-column: span 1;"><label>Roll</label><input type="number" id="mRoll" placeholder="d100"></div>
        <div class="control-group" style="grid-column: span 1;"><label>Dir</label><input type="number" id="mDir" placeholder="1-8"></div>
        
        <div class="control-group" style="grid-column: span 2;"><label>Action</label>
            <button class="btn-exec" onclick="applyMove()">EXECUTE TURN</button>
        </div>

        <button onclick="advanceDay()" style="grid-column: span 3; background: #1a2533; color: var(--water); border-color: #2c3e50;">NEXT DAY</button>
        <button class="btn-reset" onclick="hardReset()">RESET</button>
    </div>

<script>
    // --- LOGIC ENGINE (UNTOUCHED PER DOCTRINE) ---
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('viewport-container');

    const WRAP_X = 314, POLE_Y = 157, WALL_Y = 103.6, CAPITAL_Y = 83.6, COAST_X = 3, G_LIMIT = 1.75, MAX_DAYS = 228;
    
    const features = [
        { name: "NORTH WALL", type: "line", y: WALL_Y, c: "#ff4444" },
        { name: "CAPITAL", x: 0, y: CAPITAL_Y, c: "#fff" },
        { name: "COASTAL CITY", x: COAST_X, y: CAPITAL_Y, c: "#0dcaf0" },
        { name: "THE TREE", x: -7.78, y: 91.38, c: "#00e676" },
        { name: "RELIGIOUS SITE", x: -1.41, y: 82.19, c: "#f0f" }
    ];

    let state = {
        titans: {
            Lava: {x:-10, y:70, c:'#ff4444', moved:0, path:[{x:-10, y:70}]},
            Air: {x:3, y:95, c:'#ffffff', moved:0, path:[{x:3, y:95}]},
            Water: {x:25, y:83.6, c:'#0dcaf0', moved:0, path:[{x:25, y:83.6}]},
            Earth: {x:-20, y:60, c:'#a67c52', moved:0, path:[{x:-20, y:60}]},
            Sand: {x:0, y:20, c:'#ffeb3b', moved:0, path:[{x:0, y:20}]},
            Ice: {x:10, y:95, c:'#00ffff', moved:0, path:[{x:10, y:95}]}
        },
        movedToday: [], day: 1, history: []
    };

    let zoom = 8, offsetX = 0, offsetY = 0, isDragging = false, lastX, lastY, initialDist = null;

    function save() { localStorage.setItem('titanState', JSON.stringify(state)); }
    function load() {
        const saved = localStorage.getItem('titanState');
        if (saved) { state = JSON.parse(saved); updateCalendarUI(); updateDropdown(); draw(); }
    }
    function hardReset() { if(confirm("Reset entire cycle?")) { localStorage.removeItem('titanState'); location.reload(); } }

    function getCal(d) {
        const sSize = 76; const seasons = ["Genesis", "Ascent", "Descent", "Ending"];
        const sIdx = Math.floor((d-1) / sSize); const sDay = (d-1) % sSize + 1;
        const season = seasons[sIdx] || "Dormant";
        let mod = (season === "Descent") ? 0.5 : 1;
        if (sDay > 64) return { season, label: `${sDay-64} Eclipse ${season}`, mod };
        const month = sDay <= 32 ? "First" : "Second";
        const mDay = sDay <= 32 ? sDay : sDay - 32;
        return { season, label: `${mDay} ${month} ${season}`, mod };
    }

    function draw() {
        canvas.width = container.clientWidth; canvas.height = container.clientHeight;
        const cx = canvas.width/2 + offsetX, cy = canvas.height/2 + offsetY;
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        // GRID
        ctx.strokeStyle = "#1a1c20"; ctx.lineWidth = 1;
        for(let x = -WRAP_X; x <= WRAP_X; x += 10) {
            ctx.beginPath(); ctx.moveTo(cx + x*zoom, cy - POLE_Y*zoom); ctx.lineTo(cx + x*zoom, cy + POLE_Y*zoom); ctx.stroke();
        }
        for(let y = -POLE_Y; y <= POLE_Y; y += 10) {
            ctx.beginPath(); ctx.moveTo(cx - WRAP_X*zoom, cy - y*zoom); ctx.lineTo(cx + WRAP_X*zoom, cy - y*zoom); ctx.stroke();
        }

        // WATER ZONE
        ctx.fillStyle = "rgba(13, 202, 240, 0.1)";
        ctx.fillRect(cx + 3*zoom, cy - POLE_Y*zoom, (WRAP_X - 3)*zoom, (POLE_Y*2)*zoom);

        // GREEN ZONE
        ctx.fillStyle = "rgba(0, 230, 118, 0.08)"; 
        ctx.fillRect(cx - G_LIMIT*zoom, cy - WALL_Y*zoom, (G_LIMIT*2)*zoom, (WALL_Y - CAPITAL_Y)*zoom);

        // LANDMARKS
        features.forEach(f => {
            ctx.strokeStyle = f.c; ctx.fillStyle = f.c; ctx.font = "bold 9px 'Inter'";
            if(f.type === "line") {
                ctx.beginPath(); ctx.moveTo(cx - WRAP_X*zoom, cy - f.y*zoom); ctx.lineTo(cx + WRAP_X*zoom, cy - f.y*zoom); ctx.stroke();
                ctx.fillText(f.name, cx - WRAP_X*zoom + 10, cy - f.y*zoom - 5);
            } else {
                ctx.beginPath(); ctx.arc(cx + f.x*zoom, cy - f.y*zoom, 4, 0, 7); ctx.fill();
                ctx.fillText(f.name, cx + f.x*zoom + 8, cy - f.y*zoom + 4);
            }
        });

        // TITANS
        for(let k in state.titans) {
            let t = state.titans[k];
            ctx.strokeStyle = t.c; ctx.lineWidth = 2; ctx.beginPath();
            t.path.forEach((p, i) => { if(i===0) ctx.moveTo(cx+p.x*zoom, cy-p.y*zoom); else ctx.lineTo(cx+p.x*zoom, cy-p.y*zoom); }); ctx.stroke();
            ctx.fillStyle = t.c; ctx.beginPath(); ctx.arc(cx+t.x*zoom, cy-t.y*zoom, 7, 0, 7); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = "bold 10px 'Inter'";
            ctx.fillText(`${k.toUpperCase()}`, cx+t.x*zoom+10, cy-t.y*zoom-6);
            ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.font = "9px 'Inter'";
            ctx.fillText(`${t.x.toFixed(0)},${t.y.toFixed(0)} | ${t.moved.toFixed(0)} DT`, cx+t.x*zoom+10, cy-t.y*zoom+6);
        }

        // STICKY VIEWPORT COORDS
        ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.font = "bold 11px 'Inter'";
        for(let x = -WRAP_X; x <= WRAP_X; x += 50) {
            let sx = cx + x*zoom;
            if(sx > 10 && sx < canvas.width - 10) { ctx.fillText(x, sx - 8, 15); ctx.fillText(x, sx - 8, canvas.height - 10); }
        }
        for(let y = -POLE_Y; y <= POLE_Y; y += 50) {
            let sy = cy - y*zoom;
            if(sy > 20 && sy < canvas.height - 20) { ctx.fillText(y, 5, sy + 4); ctx.fillText(y, canvas.width - 30, sy + 4); }
        }
        ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.strokeRect(cx - WRAP_X*zoom, cy - POLE_Y*zoom, (WRAP_X*2)*zoom, (POLE_Y*2)*zoom);
    }

    function applyMove() {
        const name = document.getElementById('tName').value; const t = state.titans[name];
        if (!t || state.day > MAX_DAYS) return;
        state.history.push(JSON.parse(JSON.stringify(state)));
        const r = parseInt(document.getElementById('mRoll').value) || 0;
        const d8 = parseInt(document.getElementById('mDir').value) || 1;
        const off = parseFloat(document.getElementById('mShift').value) || 0;
        let dist = (r <= 10) ? 0 : (r <= 25) ? 5 : (r <= 50) ? 10 : (r <= 75) ? 20 : (r <= 90) ? 30 : 40;
        dist *= getCal(state.day).mod;
        let ang = (90 - ((d8 - 1) * 45) - off) * (Math.PI / 180);
        let nx = t.x + (Math.cos(ang) * dist), ny = t.y + (Math.sin(ang) * dist);
        if (name !== "Air" && ny >= CAPITAL_Y && ny <= WALL_Y && Math.abs(nx) < G_LIMIT) nx = nx >= 0 ? G_LIMIT : -G_LIMIT;
        if (ny > WALL_Y) ny = (name === "Earth") ? WALL_Y : WALL_Y - (ny - WALL_Y);
        if (nx > WRAP_X) nx -= (WRAP_X*2); if (nx < -WRAP_X) nx += (WRAP_X*2);
        t.x = nx; t.y = ny; t.moved += dist; t.path.push({x:nx, y:ny});
        state.movedToday.push(name); updateDropdown(); save(); draw();
    }

    container.addEventListener('touchstart', e => {
        if (e.touches.length === 2) initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        else { isDragging = true; lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; }
    }, {passive:false});
    container.addEventListener('touchmove', e => {
        e.preventDefault();
        if (e.touches.length === 2 && initialDist) {
            let d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            zoom = Math.max(1, Math.min(50, zoom * (d / initialDist))); initialDist = d; draw();
        } else if (isDragging) {
            offsetX += e.touches[0].clientX - lastX; offsetY += e.touches[0].clientY - lastY;
            lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; draw();
        }
    }, {passive:false});
    container.addEventListener('touchend', () => { isDragging = false; initialDist = null; });
    container.addEventListener('wheel', e => { e.preventDefault(); zoom = Math.max(1, Math.min(50, zoom * (e.deltaY > 0 ? 0.9 : 1.1))); draw(); }, {passive:false});
    container.addEventListener('mousedown', e => { isDragging = true; lastX = e.clientX; lastY = e.clientY; });
    window.addEventListener('mousemove', e => { if (isDragging) { offsetX += e.clientX - lastX; offsetY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; draw(); } });
    window.addEventListener('mouseup', () => isDragging = false);

    function updateDropdown() {
        const sel = document.getElementById('tName'); sel.innerHTML = "";
        Object.keys(state.titans).forEach(k => { if (!state.movedToday.includes(k)) { let o = document.createElement("option"); o.value = k; o.text = k.toUpperCase(); sel.add(o); } });
    }
    function updateCalendarUI() {
        const cal = getCal(state.day);
        document.getElementById('calDate').innerText = cal.label;
        document.getElementById('activeSeason').innerText = cal.season;
        document.getElementById('currentDay').innerText = state.day;
        document.getElementById('awake-progress').style.width = (state.day / MAX_DAYS * 100) + "%";
    }
    function advanceDay() { if (state.day < MAX_DAYS) { state.day++; state.movedToday = []; updateCalendarUI(); updateDropdown(); save(); draw(); } }
    function undo() { if (state.history.length > 0) { state = state.history.pop(); updateCalendarUI(); updateDropdown(); save(); draw(); } }
    function centerMap() { offsetX = 0; offsetY = (CAPITAL_Y * zoom); draw(); }
    window.onload = () => { load(); updateCalendarUI(); updateDropdown(); centerMap(); };
</script>
</body>
</html>
